---
title: "Mappe_1"
format: pdf
editor: visual
echo: false
warning: false
---

```{r, warning=FALSE}

rm(list=ls()) 
library(tidyverse)
library(rjstat)
library(httr)
library(cowplot)
library(lubridate)
library(dplyr)
library(ggthemes)
options(scipen = 999)
```

```{r}
url <- 'https://data.ssb.no/api/v0/no/table/09171/'
  
query <- '{
  "query": [
    {
      "code": "NACE",
      "selection": {
        "filter": "item",
        "values": [
          "nr23_6",
          "pub2X01_02",
          "pub2X03",
          "pub2X05",
          "nr2X06_09",
          "pub2X06",
          "pub2X09",
          "nr23ind",
          "pub2X10_12",
          "nr2310",
          "nr2312",
          "pub2X13_15",
          "nr2315",
          "nr2316",
          "pub2X18",
          "pub2X19_21",
          "nr2319",
          "pub2X22_23",
          "pub2X24",
          "pub2X25_28",
          "pub2X29_30",
          "pub2X31_32",
          "pub2X33",
          "pub2X35",
          "pub2X36_39",
          "pub2X41_43",
          "pub2X45_47",
          "pub2X49B",
          "pub2X50A",
          "pub2X49A_52",
          "pub2X53",
          "pub2X55_56",
          "pub2X58_63",
          "pub2X64_66",
          "pub2X68A",
          "pub2X68B",
          "pub2X69_75",
          "pub2X77_82",
          "pub2X84",
          "pub2X85",
          "pub2X86_88",
          "pub2X90_97",
          "nr24_5",
          "nr24_",
          "nr24sivil",
          "nr2482",
          "nr25_",
          "nr23_6fn",
          "nr23fn",
          "nr23mark",
          "nrimark"
        ]
      }
    },
    {
      "code": "ContentsCode",
      "selection": {
        "filter": "item",
        "values": [
          "Prob",
          "BNPB",
          "Prob2",
          "BNPB2"
        ]
      }
    }
  ],
  "response": {
    "format": "json-stat2"
  }
}'

hent_indeks.tmp1 <- url %>%
  POST(body = query, encode = "json")

df <-  hent_indeks.tmp1 %>%
  content("text") %>%
  fromJSONstat() %>%
  as_tibble()
```

```{r}
# sysselsetting i antall årsverk*(1000)
url <- 'https://data.ssb.no/api/v0/no/table/09174/'
query <- '{
  "query": [
    {
      "code": "NACE",
      "selection": {
        "filter": "vs:NRNaeringPubAgg",
        "values": [
          "nr23_6",
          "pub2X01_02",
          "pub2X03",
          "pub2X05",
          "nr2X06_09",
          "pub2X06",
          "pub2X09",
          "nr23ind",
          "pub2X10_12",
          "nr2310",
          "nr2312",
          "pub2X13_15",
          "nr2315",
          "nr2316",
          "pub2X18",
          "pub2X19_21",
          "nr2319",
          "pub2X22_23",
          "pub2X24",
          "pub2X25_28",
          "pub2X29_30",
          "pub2X31_32",
          "pub2X33",
          "pub2X35",
          "pub2X36_39",
          "pub2X41_43",
          "pub2X45_47",
          "pub2X49B",
          "pub2X50A",
          "pub2X49A_52",
          "pub2X53",
          "pub2X55_56",
          "pub2X58_63",
          "pub2X64_66",
          "pub2X68A",
          "pub2X68B",
          "pub2X69_75",
          "pub2X77_82",
          "pub2X84",
          "pub2X85",
          "pub2X86_88",
          "pub2X90_97",
          "nr24_5",
          "nr24_",
          "nr24sivil",
          "nr2482",
          "nr25_",
          "nr23_6fn",
          "nr23fn",
          "nr23mark",
          "nrimark"
        ]
      }
    },
    {
      "code": "ContentsCode",
      "selection": {
        "filter": "item",
        "values": [
          "SysselsattNorm"
        ]
      }
    }
  ],
  "response": {
    "format": "json-stat2"
  }
}'

hent_indeks.tmp <- url %>%
  POST(body = query, encode = "json")

df_lol <-  hent_indeks.tmp %>%
  content("text") %>%
  fromJSONstat() %>%
  as_tibble()
```

Oppgave 1 - 40% Lag to til fire figurer som sammenligninger sysselsetting, produksjon, bruttoprodukt, og bruttoprodukt per sysselsatt på tvers av næringer i 2021. Sysselsetting oppgis i antall årsverk, produksjon, bruttoprodukt, og bruttoprodukt per sysselsatt i løpende priser. Dere må selv avgjøre hvilke tall som er meningsfylte å sammenligne og hvorvidt dere ønsker å dele opp tallene i ulike figurer.

```{r}
df2 <- df %>%
separate(kvartal, 
         into=c("year"), 
         sep="K") %>% 
  mutate(year = (year)) %>% 
  rename(var = statistikkvariabel)

df2 <- df2 %>% 
  group_by(year, næring, var) %>% 
  summarise(verdi = sum(value))
```

```{r}
df_lol %>%
  filter(år == 2021) %>%
    filter(næring %in% c("Helse- og omsorgstjenester", 
                       "Utvinning av råolje og naturgass, inkl. tjenester", 
                       "Jordbruk og skogbruk", "Undervisning", 
                       "Bygge- og anleggsvirksomhet",
                       "Fiske, fangst og akvakultur",
                       "Kultur, underholdning og annen tjenesteyting")) %>%
  # deler på totalt for alle næringer og ganger med 100 for å få prosentvis
  ggplot(aes(x=næring, y=value/2518.7*100, fill=næring))+
  geom_col()+
  theme_minimal()+
  scale_x_discrete(guide = guide_axis(n.dodge = 2),
                   labels=c("Kultur, underholdning og annen tjenesteyting"
                            ="Kultur og underholdning", "Utvinning av råolje og naturgass, inkl. tjenester"="Råolje og naturgass"))+
  theme(legend.position = "none",
        plot.title=element_text(size=12))+
  labs(y="Prosentandel", x="",
       title="Sysselsetting for næringer (prosent) 2021")+
 scale_y_continuous(breaks = seq(from = 0, to = 30, by = 5), limits=c(0,30))



```

```{r}
df3<-df2 %>%
  pivot_wider(names_from = 'var', values_from='verdi') %>%
  rename(løpende = 'Produksjon i basisverdi. Løpende priser (mill. kr)',
         bruttoprodukt= 'Bruttoprodukt i basisverdi. Løpende priser (mill. kr)')

```

```{r}
df3 %>%
  filter(year == 2021) %>%
  filter(næring %in% c("Helse- og omsorgstjenester", 
                       "Utvinning av råolje og naturgass, inkl. tjenester", 
                       "Jordbruk og skogbruk", "Undervisning", 
                       "Bygge- og anleggsvirksomhet",
                       "Fiske, fangst og akvakultur",
                       "Kultur, underholdning og annen tjenesteyting")) %>%
  # deler på totalt for alle næringerog ganger med 100 for å få prosentvis
  ggplot(aes(x=næring, y=bruttoprodukt/5145241*100, fill=næring))+
  geom_col()+
  theme(legend.position = "none",
        plot.title=element_text(size=12))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2),
                   labels=c("Kultur, underholdning og annen tjenesteyting"
                            ="Kultur og underholdning", "Utvinning av råolje og naturgass, inkl. tjenester"="Råolje og naturgass"))+
    labs(y="Prosentandel", x="",
       title="Bruttoprodukt 2021")+
  scale_y_continuous(breaks = seq(from = 0, to = 30, by = 5), limits=c(0,30))
  

```

```{r}
df3 %>%
  filter(year == 2021) %>%
  filter(næring %in% c("Helse- og omsorgstjenester", 
                       "Utvinning av råolje og naturgass, inkl. tjenester", 
                       "Jordbruk og skogbruk", "Undervisning", 
                       "Bygge- og anleggsvirksomhet",
                       "Fiske, fangst og akvakultur",
                       "Kultur, underholdning og annen tjenesteyting")) %>%
  # deler på totalt for alle næringerog ganger med 100 for å få prosentvis
  ggplot(aes(x=næring, y=løpende/8759224*100, fill=næring))+
  geom_col()+
  theme(legend.position = "none",
        plot.title=element_text(size=12))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2),
                   labels=c("Kultur, underholdning og annen tjenesteyting"
                            ="Kultur og underholdning", "Utvinning av råolje og naturgass, inkl. tjenester"="Råolje og naturgass"))+
    labs(y="Prosentandel", x="",
       title="Produksjon 2021")+
  scale_y_continuous(breaks = seq(from = 0, to = 30, by = 5), limits=c(0,30))
```

```{r}
# sette sammen alle tre figurene til en 
df_p_b <-df3 %>%
  filter(year == 2021) %>%
  filter(næring %in% c("Helse- og omsorgstjenester", 
                       "Utvinning av råolje og naturgass, inkl. tjenester", 
                       "Jordbruk og skogbruk", "Undervisning", 
                       "Bygge- og anleggsvirksomhet",
                       "Fiske, fangst og akvakultur",
                       "Kultur, underholdning og annen tjenesteyting")) %>%
    mutate(brutto_pros=bruttoprodukt/5145241*100,
         produ_pros=løpende/8759224*100)


df_syssel <-df_lol %>%
  filter(år == 2021) %>%
    filter(næring %in% c("Helse- og omsorgstjenester", 
                       "Utvinning av råolje og naturgass, inkl. tjenester", 
                       "Jordbruk og skogbruk", "Undervisning", 
                       "Bygge- og anleggsvirksomhet",
                       "Fiske, fangst og akvakultur",
                       "Kultur, underholdning og annen tjenesteyting")) %>%
    mutate(pros_syssel=value/2518.7*100)

df_p_b <- df_p_b[order(df_p_b$næring), ]
df_syssel <- df_syssel[order(df_syssel$næring), ]

pros_syssel <- df_syssel$pros_syssel
df4 <- cbind(syssel=pros_syssel, df_p_b)

 df4 <-df4 %>%
pivot_longer(c('syssel','brutto_pros','produ_pros'), names_to = "wtf", values_to = "plot")
```

```{r}
df4 %>%
  ggplot()+
  geom_col(aes(x=næring, y=plot, fill=wtf),position = "dodge")+
  theme_minimal()+
  theme(legend.position=c(0.75,0.92),
    plot.title=element_text(size=12),
    legend.direction="horizontal",
    legend.text= element_text(size=7.5),
    legend.key.size = unit(0.4, "cm"))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2),
                   labels=c("Kultur, underholdning og annen tjenesteyting"
                            ="Kultur og underholdning", "Utvinning av råolje og naturgass, inkl. tjenester"="Råolje og naturgass"))+
    labs(y="Prosentandel", x="",
       title="Andeler (prosent) 2021")+
  scale_y_continuous(breaks = seq(from = 0, to = 30, by = 5), limits=c(0,30))+
    scale_fill_discrete(name = "", labels = c("Bruttoprodukt",
                                            "Produksjon",
                                            "Sysselsetting"))
```
